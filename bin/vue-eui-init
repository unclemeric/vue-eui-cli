#!/usr/bin/env node
const fs = require('fs')
const path = require('path')
const exists = require('fs').existsSync
const program = require('commander')
const chalk = require('chalk')
const inquirer = require('inquirer')
const home = require('user-home')
const rm = require('rimraf').sync
const QueueCmd = require('node.cmd').QueueCmd

const dirTemplates = path.join(home, '.vue-eui-template')

// program.command('init [option] <project-name>').description('generate a new project from a template')
// program
//   .usage('[option][project name]')
//   // .option('-c, --cache', 'use cached template')
//   .option('-auth', 'create auth template')
// program.on('--help', () => {
//   console.log(' Examples:')
//   console.log(chalk.gray('    # create a project in current dir:'))
//   // console.log('   $ vue-eui init [option] \t\t\t 在当前目录创建模板')
//   console.log('   $ vue-eui init [option] my-project \t\t 创建一个普通模板')
//   console.log('   $ vue-eui init [option] my-project -auth \t 创建一个带权限模板')
// })
const config = {}
const commands = process.argv.slice(3)
commands.forEach(item => {
  switch (item) {
    case '-auth':
      config.auth = true
      break
  }
})
program.parse(process.argv)
const rawName = commands[commands.length - 1]
// const dirTemplates = program.args[1]

const isCurrentDir = !rawName || rawName === '.' || rawName === './'
const projectName = isCurrentDir ? path.relative('../', process.cwd()) : rawName
const to = path.resolve(projectName || '.')
const copyTemplate = function(from, to) {
  write(to, fs.readFileSync(path.resolve(from), 'utf-8'))
}

const write = function(path, str) {
  str = str.replace(/element-ui-admin-template/g, projectName)
  str = str.replace(/element-ui-admin-auth-template/g, projectName)
  fs.writeFileSync(path, str)
}

const mkdir = function(path) {
  if (!fs.existsSync(path)) {
    fs.mkdirSync(path)
  }
}

const generate = function(cachePath, toPath) {
  var files = fs.readdirSync(cachePath) // 读取模板文件
  files.forEach(function(file) {
    if (['.history', 'node_modules', 'dist', '.lock', '.log', '.git'].indexOf(file) !== -1) {
      return false
    }
    if (fs.statSync(cachePath + '/' + file).isFile()) {
      if (!fs.existsSync(toPath)) {
        fs.mkdirSync(toPath)
      }
      copyTemplate(cachePath + '/' + file, toPath + '/' + file)
    } else if (fs.statSync(cachePath + '/' + file).isDirectory()) {
      var filePath = toPath + '/' + file
      mkdir(filePath)
      generate(cachePath + '/' + file, filePath)
    }
  })
}

const run = function() {
  if (exists(to)) {
    inquirer
      .prompt([
        {
          type: 'confirm',
          message: isCurrentDir ? 'Generate project in current directory?' : 'Target directory exists, Continue?',
          name: 'continue'
        }
      ])
      .then(answers => {
        if (answers.continue) {
          generate(dirTemplates, to)
          console.log(chalk.green('项目新建成功！'))
        }
      })
      .catch(function(err) {
        console.error(chalk.red(err))
      })
    // cmd.run(`mkdir ${home}/vue-eui-template`, function(err, data) {
  } else {
    generate(dirTemplates, to)
    console.log(chalk.green('项目新建成功！'))
  }
}

if (exists(dirTemplates)) {
  rm(dirTemplates)
} else {
  mkdir(dirTemplates)
}
const ins = new QueueCmd()
ins.queue(
  `git clone ${
    config.auth
      ? 'ssh://git@10.0.82.224:2222/hwagain-FE/element-ui-admin-auth-template.git'
      : 'ssh://git@10.0.82.224:2222/hwagain-FE/element-ui-admin-template.git'
  } ${dirTemplates}`,
  function(data) {
    console.log(data)
    run()
  }
)
